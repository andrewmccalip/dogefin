<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doge to the Moon</title>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <main id="main-content">
        <!-- Twitter Header -->
        <div class="twitter-header">
            <a href="https://twitter.com/andrewmccalip" class="twitter-link">
                <img src="{{ url_for('static', filename='images/twitter.png') }}" alt="Twitter">
                <span>Slide into DMs with your offer</span>
            </a>
        </div>

        <header class="site-header">
            <h1 class="title">"Doge to the moon"</h1>
            <p class="subtitle">A physical manifestation of internet memes</p>
            <p class="author">Brought to you by the slightly unhinged LA99 superconductor engineer, Andrew McGalip</p>
            
            <!-- Hero Image -->
            <div class="hero-image">
                <img src="{{ url_for('static', filename='images/header.jpg') }}" alt="I will succeed because I'm crazy">
            </div>

            <div class="offer-section">
                <div class="offer-form">
                    <div class="amount-input">
                        <input type="number" id="offerAmount" placeholder="Enter price ($)" min="0" step="0.01">
                        <button id="submitOffer" class="offer-button">Make Offer</button>
                    </div>
                    <div class="email-input" style="display: none;">
                        <input type="email" id="offerEmail" placeholder="Enter your email">
                        <button id="submitEmail" class="offer-button">Submit</button>
                    </div>
                </div>
                <div class="highest-bid">
                    <div class="typewriter" id="highestBidText"></div>
                </div>
            </div>
        </header>

        <section class="gallery-section">
            <div class="gallery-grid">
                {% for image in images %}
                <a href="{{ url_for('static', filename='images/' + image.full) }}" 
                   class="gallery-item" 
                   data-aspect="{{ image.aspect if image.aspect else 'landscape' }}"
                   target="_blank">
                    <img src="{{ url_for('static', filename='images/' + image.full) }}" 
                         alt="{{ image.caption }}"
                         loading="lazy">
                </a>
                {% endfor %}
            </div>
        </section>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.1/+esm'

        // Initialize Supabase client
        const supabaseUrl = 'https://arcnledoyrviarjahaqk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyY25sZWRveXJ2aWFyamFoYXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUxNjI3MDQsImV4cCI6MjA1MDczODcwNH0.YEvLzw3DSCh-wsURYv7f2XeujA7P0Rax66xFd_YCU7Q';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        let terminalHistory = [];

        async function typewriterAnimation(text, element, speed = 80) {
            // Add text to history
            terminalHistory.push(text);
            
            // Clear and rebuild entire history
            element.innerHTML = '';
            
            // Rebuild all lines from history
            for (let i = 0; i < terminalHistory.length; i++) {
                const line = document.createElement('div');
                line.classList.add('terminal-line');
                if (i < terminalHistory.length - 1) {
                    line.classList.add('old-text');
                    line.textContent = terminalHistory[i];
                } else {
                    // Animate only the newest line
                    for (let j = 0; j < terminalHistory[i].length; j++) {
                        line.textContent = terminalHistory[i].substring(0, j + 1);
                        await new Promise(resolve => setTimeout(resolve, speed));
                    }
                }
                element.appendChild(line);
            }
        }

        async function getAndDisplayHighestBid() {
            const typewriterElement = document.getElementById('highestBidText');
            
            await typewriterAnimation('Retrieving highest bid from db...', typewriterElement);
            
            try {
                const { data, error } = await supabaseClient
                    .from('offer')
                    .select('price')
                    .order('price', { ascending: false })
                    .limit(1);

                if (error) throw error;

                const highestBid = data && data[0] ? data[0].price : 0;
                await typewriterAnimation(`Current highest bid: $${highestBid.toLocaleString()}`, typewriterElement);
                
            } catch (error) {
                console.error('Error fetching highest bid:', error);
                await typewriterAnimation('Error fetching highest bid', typewriterElement);
            }
        }

        // Run on page load
        window.addEventListener('load', () => {
            getAndDisplayHighestBid();
        });

        document.getElementById('submitOffer').addEventListener('click', function() {
            const price = document.getElementById('offerAmount').value;
            if (price) {
                document.querySelector('.email-input').style.display = 'flex';
            }
        });

        document.getElementById('submitEmail').addEventListener('click', async function() {
            const email = document.getElementById('offerEmail').value;
            const price = parseFloat(document.getElementById('offerAmount').value);
            
            if (email && !isNaN(price)) {
                try {
                    console.log('Attempting to submit:', { price, email });
                    
                    const { data, error } = await supabaseClient
                        .from('offer')
                        .insert({
                            price: price,
                            email: email,
                        })
                        .select();

                    if (error) {
                        console.error('Submission error:', error);
                        alert('Error submitting offer: ' + error.message);
                        return;
                    }

                    console.log('Success:', data);
                    alert('Offer submitted successfully!');
                    
                    // Reset form
                    document.getElementById('offerAmount').value = '';
                    document.getElementById('offerEmail').value = '';
                    document.querySelector('.email-input').style.display = 'none';

                    // Update the highest bid display after successful submission
                    getAndDisplayHighestBid();
                    
                } catch (error) {
                    console.error('Catch error:', error);
                    alert('Error submitting offer. Please try again.');
                }
            } else {
                alert('Please enter a valid price and email.');
            }
        });
    </script>
</body>
</html> 